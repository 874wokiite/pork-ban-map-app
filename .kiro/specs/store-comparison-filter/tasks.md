# Implementation Plan

## 概要
店舗比較・フィルター式マッチング機能の実装タスク。スペクトラムバー表示とフィルター機能を段階的に実装する。

---

- [x] 1. 型定義とデータ基盤の整備
- [x] 1.1 新しい評価軸の型定義を追加
  - 4軸評価（皮スタイル、餡スタイル、味わい、サイズ）のデータ構造を定義
  - 各軸の設定情報（キー、左ラベル、右ラベル）を定義
  - ユーザーの好み設定を保持するデータ構造を定義
  - マッチング結果（店舗とマッチ度のペア）のデータ構造を定義
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [x] 1.2 既存の型定義を非推奨化
  - 旧5軸評価の型を非推奨としてマーク
  - 新旧型の共存を可能にする
  - _Requirements: 型定義の移行に関連_

---

- [x] 2. マッチング計算ロジックの実装
- [x] 2.1 マッチ度計算の関数を作成
  - ユーザーの好みと店舗の評価値の差分を計算する機能
  - 各軸の類似度を0-1の範囲で算出する機能
  - 4軸の類似度を統合して総合マッチ度（0-100%）を算出する機能
  - _Requirements: 3.1, 3.2_

- [x] 2.2 店舗リストのマッチング・ソート機能を作成
  - 複数店舗のマッチ度を一括計算する機能
  - マッチ度の高い順に店舗をソートする機能
  - AI分析データがない店舗を除外する機能
  - _Requirements: 2.5, 3.3_

- [x] 2.3 マッチング計算のユニットテストを作成
  - 各軸の差分計算が正しいことを検証
  - 総合マッチ度の計算が正しいことを検証
  - ソート順が正しいことを検証
  - データなし店舗の除外が正しいことを検証
  - _Requirements: 3.1, 3.2, 3.3_

---

- [x] 3. スペクトラムバーコンポーネントの実装
- [x] 3.1 読み取り専用スペクトラムバーを作成
  - 水平バーで評価値の位置を視覚化する表示
  - バーの両端に対比ラベル（例：「薄皮ふわふわ」↔「厚皮もちもち」）を表示
  - 1-10の評価値に対応するインジケーター位置の計算
  - モバイル・デスクトップ両対応のレスポンシブレイアウト
  - _Requirements: 1.1, 1.2, 1.3, 5.1, 5.2, 5.3_

- [x] 3.2 スライダー操作可能なスペクトラムバーを作成
  - ドラッグ操作で値を変更できるインタラクション
  - タッチ操作に対応したスライダー機能
  - 値変更時のコールバック呼び出し
  - 現在値のリアルタイム表示
  - _Requirements: 2.1, 2.2, 5.1, 5.2_

- [x] 3.3 スペクトラムバーのテストを作成
  - 正しい位置にインジケーターが表示されることを検証
  - スライダー操作で値が変更されることを検証
  - 両端ラベルが正しく表示されることを検証
  - _Requirements: 1.2, 1.3, 2.1, 2.2_

---

- [x] 4. フィルター機能のフックを実装
- [x] 4.1 マッチングフィルターのカスタムフックを作成
  - ユーザーの好み設定を状態管理する機能
  - 好み変更時にマッチング結果を自動再計算する機能
  - 個別の軸を更新する機能
  - 全軸を中央値（5）にリセットする機能
  - パフォーマンス最適化（useMemo、useCallback使用）
  - _Requirements: 2.3, 4.5, 6.1_

- [x] 4.2 フックのユニットテストを作成
  - 初期状態が正しいことを検証
  - 好み変更でマッチ結果が更新されることを検証
  - リセット機能が正しく動作することを検証
  - 100ms以内のレスポンスを検証
  - _Requirements: 2.3, 4.5, 6.1_

---

- [x] 5. フィルターモーダルの実装
- [x] 5.1 フィルターモーダルの基本構造を作成
  - モーダルの開閉制御（Escキー、背景クリック対応）
  - モーダル表示中のbodyスクロール制御
  - ヘッダー部分（タイトル、閉じるボタン）
  - レスポンシブなモーダルサイズ
  - _Requirements: 4.2, 5.3_

- [x] 5.2 好み設定スライダーセクションを実装
  - 4軸それぞれのスライダー付きスペクトラムバーを表示
  - 各スライダーの操作でリアルタイムに値を更新
  - リセットボタンで全スライダーを中央値に戻す機能
  - _Requirements: 2.1, 2.2, 4.5_

- [x] 5.3 マッチング結果リストを実装
  - マッチ度付きの店舗カードを一覧表示
  - マッチ度の高い順にソートして表示
  - 各店舗カードにマッチ度（%）を表示
  - 店舗カードタップで詳細モーダルへ遷移
  - _Requirements: 2.4, 2.5, 4.3, 4.4_

- [x] 5.4 フィルターモーダルのテストを作成
  - モーダルの開閉が正しく動作することを検証
  - スライダー操作で結果が更新されることを検証
  - 店舗選択で詳細モーダルが表示されることを検証
  - リセット機能が正しく動作することを検証
  - _Requirements: 4.2, 4.3, 4.4, 4.5_

---

- [x] 6. 店舗詳細モーダルへのスペクトラムバー統合
- [x] 6.1 既存の店舗詳細モーダルにスペクトラムバーを追加
  - レーダーチャート表示をスペクトラムバー表示に置き換え
  - 4軸すべてのスペクトラムバーを縦に並べて表示
  - AI分析データがない場合はセクションを非表示
  - 既存のモーダルレイアウトとの調和
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 6.2 統合テストを作成
  - スペクトラムバーが正しく表示されることを検証
  - データなし店舗でセクションが非表示になることを検証
  - 既存機能が影響を受けないことを検証
  - _Requirements: 1.1, 1.4_

---

- [x] 7. メイン画面への統合
- [x] 7.1 フィルターボタンをマップ画面に追加
  - マップ画面上にフィルターアクセス用のボタンを配置
  - ボタンのスタイリング（アイコン、色、サイズ）
  - モバイル・デスクトップ両対応の配置
  - _Requirements: 4.1_

- [x] 7.2 フィルターモーダルをメイン画面に統合
  - フィルターボタンクリックでモーダルを表示
  - 店舗選択時に詳細モーダルへ遷移する連携
  - 複数モーダル間の状態管理
  - _Requirements: 4.2, 4.4_

- [x] 7.3 E2Eテストを作成
  - フィルターボタン→モーダル表示の流れを検証
  - スライダー操作→結果更新→店舗選択の流れを検証
  - 店舗詳細モーダルでのスペクトラムバー表示を検証
  - 全体的なレスポンシブ動作を検証
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3_

---

- [x] 8. パフォーマンス最適化と仕上げ
- [x] 8.1 パフォーマンス最適化
  - スライダー操作時の再計算を100ms以内に最適化
  - 不要な再レンダリングの防止
  - メモ化の適切な適用
  - _Requirements: 6.1_

- [x] 8.2 ローディング状態の実装
  - 計算処理中のローディングインジケーター表示
  - ユーザーへの処理中フィードバック
  - _Requirements: 6.3_

- [x] 8.3 旧コンポーネントの非推奨化
  - SingleStoreRadarChartに非推奨マークを追加
  - 移行ガイドのコメントを追加
  - _Requirements: 移行戦略に関連_
